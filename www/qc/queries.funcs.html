<script type="text/javascript">
	var cluster_name = '${param.cluster}';
	var rq_table = null;
	var cq_table = null;
    
	function cancelQuery(parent, cuqId) {
		$(parent).text("Canceling");
		$.getJSON('/api/qc/cancelQuery?cluster='+cluster_name+'&cuqId='+cuqId, function(result) {
			console.log(result);
		});
	}

	function addRunningQuery(q) {
		var qTr = $('#'+q.cuqId, rq_table);
		if (qTr.length > 0) {
			$('.qState', qTr).html(q.state);
			$('.qRows', qTr).html(q.rowCnt);
		} else {
			var contents = '';
			contents += '<tr id="' + q.cuqId + '" stime="'+q.start+'">'
					+ '<td class="qServer">'+ q.server + ':' + q.port + '</td>'
					+'<td class="qId">' + q.queryId + '</td>'
					+'<td class="qUser">' + q.userId + '</td>'
					+'<td class="qQuery">' + q.query + '</td>'
					+'<td class="qState">' + q.state + '</td>'
					+'<td class="qClient">' + q.client + '</td>'
					+'<td class="qRows qRight">' + q.rowCnt + '</td>'
					+'<td class="qStartTime">' + formatDate(new Date(q.start)) + '</td>'
					+'<td class="qElapsedTime qRight">' + ((new Date() - q.start)/1000).toFixed(0) + '</td>'
					+'<td class="qCancel"><a href="#" class="btn btn-primary btn-xs" data-style="zoom-in" data-size="xs" data-spinner-size="28" data-spinner-color="#ffffff" data-cuqId="'+ q.cuqId+'">Cancel</a>' + '</td>'
					+'</tr>';
			$(rq_table).prepend(contents);
			$('#' + q.cuqId + ' .qCancel a', rq_table).bind("click", function(e) {
				cuqId = $(this).attr("data-cuqId");
				cancelQuery(this, cuqId);
			});
		}
	}

	function updateRunningQuery(q) {
        var qTr = $('#'+q.cuqId, rq_table);
        if (qTr.length > 0) {
            $('.qState', qTr).html(q.state);
            $('.qRows', qTr).html(q.rowCnt);
        }
    }
	
	function updateElapsedTimeRQ() {
		$('.qElapsedTime', rq_table).each(function() {
			var t = Number(($(this).parent().attr("stime")));
			$(this).text(((new Date().getTime()-t)/1000).toFixed(0));
		});
	}

	function getRunningQueries() {
		$.ajax('/api/qc/runningQueries?cluster=' + cluster_name, {
			success : function(data) {
                var qs = data.data;
                var contents="";
				for (var i = qs.length - 1; i > -1; i--) {
					q = qs[i];
					contents += '<tr id="' + q.cuqId + '" stime="'+q.start+'">'
                    + '<td class="qServer">'+ q.server + ':' + q.port + '</td>'
                    +'<td class="qId">' + q.queryId + '</td>'
                    +'<td class="qUser">' + q.userId + '</td>'
                    +'<td class="qQuery">' + q.query + '</td>'
                    +'<td class="qState">' + q.state + '</td>'
                    +'<td class="qClient">' + q.client + '</td>'
                    +'<td class="qRows qRight">' + q.rowCnt + '</td>'
                    +'<td class="qStartTime">' + formatDate(new Date(q.start)) + '</td>'
                    +'<td class="qElapsedTime qRight">' + ((new Date() - q.start)/1000).toFixed(0) + '</td>'
                    +'<td class="qCancel"><a href="#" class="btn btn-primary btn-xs" data-style="zoom-in" data-size="xs" data-spinner-size="28" data-spinner-color="#ffffff" data-cuqId="'+ q.cuqId+'">Cancel</a>' + '</td>'
                    +'</tr>';
				}
				$(rq_table).html(contents);
				$('#' + q.cuqId + ' .qCancel a', rq_table).bind("click", function(e) {
	                cuqId = $(this).attr("data-cuqId");
	                cancelQuery(this, cuqId);
	            });
			},
			error : function(xhr, ts, err) {
				//setTimeout(getRunningQueries, 10000);
			}
		});
	}

	function addCompleteQuery(q) {
		var contents = '<tr id="'+q.cuqId+'">'
			        +'<td class="qServer">'+ q.server+':'+ q.port+'</td>'
			        +'<td class="qId">'+q.queryId+'</td>'
			        +'<td class="qUser">'+ q.userId+'</td>'
			        +'<td class="qQuery">'+ q.query+'</td>'
			        +'<td class="qState">'+ q.state+'</td>'
			        +'<td class="qClient">'+q.client+'</td>'
			        +'<td class="qRows qRight">'+ q.rowCnt+'</td>'
			        +'<td class="qStartTime">'+formatDate(new Date(q.start))+'</td>'
			        +'<td class="qEndTime">'+formatDate(new Date(q.end))+'</td>'
			        +'<td class="qElapsedTime qRight">'+(q.end - q.start)+'</td>'
			        +'</tr>';
		$(cq_table).prepend(contents);
		$('tr:gt(100)', cq_table).remove();
	}

	function getCompleteQueries() {
		$.getJSON('/api/qc/completeQueries?cluster='+cluster_name,
			function(r) {
				var contents = '';
				for (var i = 0; i < r.data.length; i++) {
					q = r.data[i];
					contents += '<tr id="'+q.cuqId+'">'
							+'<td class="qServer">'+ q.server+':'+ q.port+'</td>'
							+'<td class="qId">'+q.queryId+'</td>'
							+'<td class="qUser">'+ q.userId+'</td>'
							+'<td class="qQuery">'+ q.query+'</td>'
							+'<td class="qState">'+ q.state+'</td>'
							+'<td class="qClient">'+q.client+'</td>'
							+'<td class="qRows qRight">'+ q.rowCnt+'</td>'
							+'<td class="qStartTime">'+formatDate(new Date(q.start))+'</td>'
							+'<td class="qEndTime">'+formatDate(new Date(q.end))+'</td>'
							+'<td class="qElapsedTime qRight">'+(q.end - q.start)+'</td>'
							+'</tr>';
				}
				$('#queriescomplete tbody').html(contents);
				$('#imgcqrefreshinprogress').hide();
			});
	}

	var g_websocket = null;
	function initWebSocket() {
		if (g_websocket != null) {
			g_websocket.onclose = function() {
			};
			g_websocket.close();
		}

		g_websocket = new WebSocket('ws://' + window.location.host
				+ '/api/qc/websocket');
		g_websocket.onopen = function() {
			// subscribe to a cluster
			var subscribe = {
				'r' : 'subscribe',
				'c' : 'cluster',
				'd' : cluster_name
			};
			this.send(JSON.stringify(subscribe));
		};
		g_websocket.onmessage = function(message) {
			var msg = JSON.parse(message.data);
			try {
				switch (msg.t) {
				case 'data':
					for (var i=0;i<msg.q.length;i++) {
						if (msg.q[i].end == 0) {
							addRunningQuery(msg.q[i]);
						} else {
							$('#'+msg.q[i].cuqId, rq_table).remove();
							addCompleteQuery(msg.q[i]);
						}
					}
                    for (var i=0;i<msg.c.length;i++) {
                        updateRunningQuery(msg.c[i]);
                        if (msg.c[i].end > 0) {
                            var tr = $('#'+msg.q[i].cuqId, rq_table).remove();
                            $(cq_table).prepend(tr);
                            //addCompleteQuery(msg.profiles[i]);
                        }
                    }
					break;
				case 'subscribe':
					break;
				case 'pong':
					break;
				case 'unsupport':
					console.log(msg.d);
					this.close();
					break;
				default:
				    this.close();
					break;
				}
			} catch (ex) {
				console.log('error parsing msg', msg, ex);
				this.close();
			}
		};
		g_websocket.onclose = function() {
			console.log('websocket closed');
			g_websocket = null;
			setTimeout(pingWebSocket, 5 * 1000);
		};
	}

	function pingWebSocket() {
		if (g_websocket == null) {
			initWebSocket();
		} else {
			var ping = {
				'r' : 'ping'
			};
			g_websocket.send(JSON.stringify(ping));
		}
	}
</script>
